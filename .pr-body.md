## Story Overview

**Story:** 1.3 - Redis and BullMQ Setup
**Epic:** 1 - Project Foundation & Infrastructure
**Status:** Review âœ…

Implements Redis and BullMQ infrastructure for handling PDF processing jobs asynchronously without blocking the UI.

---

## ğŸ“‹ Summary

This PR adds the complete Redis and BullMQ infrastructure needed for background job processing in the Deepread application. The implementation follows Next.js 14 App Router best practices and includes comprehensive TypeScript type safety.

### What This Enables

- âœ… Asynchronous PDF processing without blocking the user interface
- âœ… Automatic retry logic with exponential backoff for transient failures
- âœ… Job status tracking and progress monitoring
- âœ… Horizontal scalability (support for 3-5 concurrent jobs)
- âœ… Crash recovery and state persistence via Redis

---

## ğŸ”§ Implementation Details

### 1. Redis Client with Singleton Pattern

**File:** `lib/services/redis.ts`

```typescript
const globalForRedis = globalThis as unknown as {
  redis: Redis | undefined;
};

export const redis = globalForRedis.redis ?? createRedisClient();
```

**Why the globalThis pattern?**

Next.js App Router bundles modules across multiple webpack chunks, which breaks traditional singleton patterns. Using `globalThis` ensures the Redis connection is shared across the entire application, preventing connection pool exhaustion. This follows the same pattern used by Prisma for database connections.

**Features:**
- âœ… Automatic retry strategy: exponential backoff (50ms increments, max 2s)
- âœ… Connection event handlers for debugging
- âœ… Environment variable configuration (`REDIS_URL`)
- âœ… Production-ready error handling

### 2. BullMQ Queue Configuration

**File:** `lib/services/queue.ts`

**Exponential Backoff Configuration:**
```typescript
{
  attempts: 3,
  backoff: {
    type: 'exponential',
    delay: 2000  // Results in: 2s, 4s, 8s delays
  }
}
```

**Formula:** `2^(attempts - 1) * delay` milliseconds
**Total retry time:** ~14 seconds

**Job Data Types:**
- `upload`: File validation and storage
- `extraction`: PDF text and content extraction
- `ai-metadata`: AI-powered summary and chapter detection
- `content-conversion`: HTML/markdown generation

**Job Cleanup Strategy:**
- Keeps last 100 completed jobs for auditing
- Keeps last 50 failed jobs for debugging
- Automatic cleanup prevents Redis memory bloat

**Helper Functions:**
- `getJobStatus(jobId)`: Retrieve job state, progress, and error information

### 3. Development Infrastructure

**File:** `docker-compose.yml`

```yaml
services:
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    command: redis-server --appendonly yes
```

**Features:**
- âœ… Redis 7.x (latest stable)
- âœ… Data persistence with AOF (appendonly mode)
- âœ… Health check configured
- âœ… Volume mount for data persistence across restarts

**Alternative Setup (Without Docker):**
- **Windows:** Download from [tporadowski/redis](https://github.com/tporadowski/redis/releases)
- **macOS:** `brew install redis && brew services start redis`
- **Linux:** `sudo apt-get install redis-server`

### 4. Comprehensive Test Suite

**File:** `tests/manual/redis-bullmq-test.ts`

**Tests Cover:**
1. âœ… Redis connection verification
2. âœ… Queue and worker creation
3. âœ… Job processing end-to-end
4. âœ… Retry logic with exponential backoff
5. âœ… Job status tracking
6. âœ… Failure handling and error messages

**How to Run:**
```bash
# Start Redis
docker-compose up -d

# Run tests
npx tsx tests/manual/redis-bullmq-test.ts
```

---

## ğŸ“¦ Dependencies Added

| Package | Version | Purpose |
|---------|---------|---------|
| `bullmq` | 5.66.5 | Modern TypeScript-first job queue |
| `ioredis` | 5.9.1 | Redis client (required by BullMQ) |

### Why These Versions?

**bullmq@5.66.5:**
- Latest stable version (published 4 days ago)
- No explicit Node.js version constraints
- Compatible with Node.js 25.x (verified)
- Full TypeScript support built-in

**ioredis@5.9.1:**
- Latest stable version
- Required peer dependency of BullMQ
- BullMQ uses ioredis internally for all Redis operations

---

## ğŸ—ï¸ Architecture Alignment

This implementation aligns with the architecture document specifications:

| Requirement | Implementation |
|------------|----------------|
| Redis as in-memory store | âœ… ioredis client with singleton pattern |
| BullMQ job queue | âœ… pdf-processing queue configured |
| Retry logic | âœ… Exponential backoff: 3 attempts (2s, 4s, 8s) |
| Progress tracking | âœ… getJobStatus() helper function |
| Concurrent jobs (3-5) | âœ… Queue supports concurrent workers |
| Crash recovery | âœ… Jobs persist in Redis |
| State persistence | âœ… AOF enabled in Docker setup |

---

## ğŸ”¬ Research Conducted

Extensive research was performed before implementation to ensure best practices:

### BullMQ Research
- âœ… Official documentation reviewed
- âœ… Exponential backoff formula verified
- âœ… Node.js 25.x compatibility confirmed
- âœ… Production deployment patterns studied

### Next.js 14 Integration
- âœ… App Router singleton pattern requirements researched
- âœ… Connection exhaustion prevention patterns verified
- âœ… globalThis pattern validated from Prisma docs

---

## âœ… Acceptance Criteria Met

All acceptance criteria from Story 1.3 have been satisfied:

- âœ… Redis running locally (Docker Compose provided)
- âœ… Connect to Redis from Next.js application
- âœ… BullMQ queue initialized with proper TypeScript types
- âœ… Can add test job to queue and process successfully
- âœ… Job status can be retrieved and tracked
- âœ… Failed jobs retry with exponential backoff (verified in tests)

---

## ğŸ§ª Testing Instructions

### Prerequisites
1. Ensure Redis is running: `docker-compose up -d`

### Run Tests
```bash
npx tsx tests/manual/redis-bullmq-test.ts
```

---

## ğŸ“ Files Changed

### New Files
- `lib/services/redis.ts` - Redis client with singleton pattern
- `lib/services/queue.ts` - BullMQ queue configuration
- `docker-compose.yml` - Local Redis container setup
- `tests/manual/redis-bullmq-test.ts` - Comprehensive test suite

### Modified Files
- `package.json` - Added bullmq and ioredis dependencies
- `package-lock.json` - Dependency lock file updated

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
